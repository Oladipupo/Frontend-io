{"version":3,"file":"index.js","sources":["../src/http.js","../src/server.js","../src/index.js"],"sourcesContent":["import { readAll } from 'https://deno.land/std@0.106.0/io/mod.ts';\n\n// import type { ServerRequest } from 'https://deno.land/std@0.106.0/http/server.ts';\n\n/**\n * Converts request headers from Headers to a plain key-value object, as used in node\n * @param {Headers} headers Browser/Deno Headers object\n * @returns {object} Plain key-value headers object\n */\nexport const headers_to_object = (headers) => Object.fromEntries(headers.entries());\n\n/**\n * @param {ServerRequest} req Deno server request object\n * @returns {Promise<null | Uint8Array>} Resolves with the request body raw buffer\n */\nexport async function getRawBody(req) {\n\tconst { headers } = req;\n\t// take the first content-type header\n\t// TODO: is split(',') enough?\n\tconst type = headers.get('content-type')?.split(/,;\\s*/)?.[0];\n\tif (type === null) {\n\t\treturn null;\n\t}\n\n\tconst data = await readAll(req.body);\n  return data;\n}\n","import { app, dirname, existsSync, fromFileUrl, join, serveStatic } from './deps.ts';\nimport { getRawBody, headers_to_object } from './http.js';\n\n// App is a dynamic file built from the application layer.\n\nconst __dirname = dirname(fromFileUrl(import.meta.url));\nconst noop_handler = (_req, _res, next) => next();\nconst paths = {\n\tassets: join(__dirname, '/assets'),\n\tprerendered: join(__dirname, '/prerendered')\n};\n\nexport function createServer({ render }) {\n\tconst prerendered_handler = existsSync(paths.prerendered)\n\t\t? serveStatic(paths.prerendered, {\n\t\t\t\tetag: true,\n\t\t\t\tmaxAge: 0\n\t\t\t\t// gzip: true,\n\t\t\t\t// brotli: true\n\t\t  })\n\t\t: noop_handler;\n\n\tconst assets_handler = existsSync(paths.assets)\n\t\t? serveStatic(paths.assets, {\n\t\t\t\tmaxAge: 31536000,\n\t\t\t\timmutable: true\n\t\t\t\t// setHeaders: (res, pathname) => {\n\t\t\t\t// \t// @ts-expect-error - dynamically replaced with define\n\t\t\t\t// \tif (pathname.startsWith(/* eslint-disable-line no-undef */ APP_DIR)) {\n\t\t\t\t// \t\tres.setHeader('cache-control', 'public, max-age=31536000, immutable');\n\t\t\t\t// \t}\n\t\t\t\t// },\n\t\t\t\t// gzip: true,\n\t\t\t\t// brotli: true\n\t\t  })\n\t\t: noop_handler;\n\n\tconst server = app().use(\n\t\t// TODO: handle response compression\n\t\t// compression({ threshold: 0 }),\n\t\tassets_handler,\n\t\tprerendered_handler,\n\t\tasync (req, res) => {\n\t\t\tconst parsed = new URL(req.url || '', 'http://localhost');\n\n\t\t\tlet body;\n\n\t\t\ttry {\n\t\t\t\tbody = await getRawBody(req);\n\t\t\t} catch (err) {\n\t\t\t\tres.statusCode = err.status || 400;\n\t\t\t\treturn res.end(err.reason || 'Invalid request body');\n\t\t\t}\n\n\t\t\tconst rendered = await render({\n\t\t\t\tmethod: req.method,\n\t\t\t\theaders: headers_to_object(req.headers), // TODO: what about repeated headers, i.e. string[]\n\t\t\t\tpath: parsed.pathname,\n\t\t\t\tquery: parsed.searchParams,\n\t\t\t\trawBody: body\n\t\t\t});\n\n\t\t\tif (rendered) {\n\t\t\t\tres.setStatus(rendered.status);\n\t\t\t\tres.set(rendered.headers);\n\t\t\t\tres.send(rendered.body);\n\t\t\t} else {\n\t\t\t\tres.setStatus(404);\n\t\t\t\tres.send('Not found');\n\t\t\t}\n\t\t}\n\t);\n\n\treturn server;\n}\n","import { init, render } from '../output/server/app.js';\nimport { path, host, port } from './env.js';\nimport { createServer } from './server.js';\n\ninit();\n\nconst addr = path || `${host}:${port}`;\nconst instance = createServer({ render }).listen(addr, (err) => {\n\tif (err) {\n\t\tconsole.error('error', err);\n\t} else {\n\t\tconsole.log(`Listening on http://${addr}`);\n\t}\n});\n\nexport { instance };\n"],"names":[],"mappings":"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"}